```mermaid
graph TD
    classDef startend fill:#F5EBFF,stroke:#BE8FED,stroke-width:2px
    classDef process fill:#E5F6FF,stroke:#73A6FF,stroke-width:2px
    classDef decision fill:#FFF6CC,stroke:#FFBC52,stroke-width:2px
    classDef io fill:#FFEBEB,stroke:#E68994,stroke-width:2px
    
    A([开始解析]):::startend --> B{输出是否包含Action?}:::decision
    B -->|是| C(提取Action名称和输入):::process
    B -->|否| D{输出是否包含Final Answer?}:::decision
    
    C --> E(尝试解析Action Input为JSON):::process
    E --> F{JSON解析成功?}:::decision
    F -->|是| G(检查并修正JSON结构):::process
    F -->|否| H(尝试修复JSON格式):::process
    H --> I{修复后解析成功?}:::decision
    I -->|是| G
    I -->|否| J(记录错误，返回原始文本):::process
    
    G --> K{JSON中是否有"command"键?}:::decision
    K -->|是| L(将"command"改为"query"):::process
    K -->|否| M(直接使用JSON):::process
    L --> N(返回AgentAction对象):::process
    M --> N
    
    D -->|是| O(提取Final Answer内容):::process
    D -->|否| P(将整个输出作为最终答案):::process
    O --> Q(返回AgentFinish对象):::process
    P --> Q
    
    N --> R([结束解析]):::startend
    Q --> R
    J --> R
```