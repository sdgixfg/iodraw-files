```mermaid
graph LR
    classDef startend fill:#F5EBFF,stroke:#BE8FED,stroke-width:2px
    classDef process fill:#E5F6FF,stroke:#73A6FF,stroke-width:2px
    classDef decision fill:#FFF6CC,stroke:#FFBC52,stroke-width:2px
    
    %% 定义节点位置（使用%%%编号控制水平位置）
    A([开始]):::startend %%{rank:0}
    B{选择模板类型}:::decision %%{rank:1}
    C(选择'qwen'模板):::process %%{rank:2}
    D(选择'structured-chat-agent'模板):::process %%{rank:2}
    E(获取模板字符串):::process %%{rank:3}
    F(创建模板实例):::process %%{rank:0}
    G(处理中间步骤):::process %%{rank:1}
    H(设置agent_scratchpad):::process %%{rank:2}
    I(处理工具列表):::process %%{rank:3}
    J(创建工具名称列表):::process %%{rank:0}
    K(格式化模板):::process %%{rank:1}
    L(返回消息列表):::process %%{rank:2}
    M([结束]):::startend %%{rank:3}
    
    %% 连接节点
    A --> B
    B --> C
    B --> D
    C --> E
    D --> E
    E --> F
    F --> G
    G --> H
    H 
```